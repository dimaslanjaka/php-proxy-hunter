#!/bin/sh

# Determine the current script directory and project directory
SCRIPT_DIR=$(dirname "$(realpath "$0")")
PROJECT_DIR=$(dirname "$SCRIPT_DIR")

# Detect if running on a VPS or desktop
IS_VPS=0
if [ -f /sys/class/dmi/id/product_name ]; then
  PRODUCT_NAME=$(cat /sys/class/dmi/id/product_name 2>/dev/null | tr '[:upper:]' '[:lower:]')
  if echo "$PRODUCT_NAME" | grep -qE "vps|virtual|kvm|qemu|xen|vmware|hyper-v|cloud"; then
    IS_VPS=1
  fi
fi

# run commit history builder on non-VPS environments
if [ $IS_VPS -eq 0 ]; then
  node --no-warnings=ExperimentalWarning --loader ts-node/esm "$CWD/src/dev/git-history.builder.ts"
fi

if command -v git-lfs >/dev/null 2>&1; then
  git lfs post-commit "$@"
else
  echo >&2 "Warning: Git LFS is not installed; skipping git lfs post-commit hook."
fi

# configure local git merge driver for `.husky/hash.txt` after commit
git config --local merge.resolve_hash.name "Resolve .husky/hash.txt with custom script" || true
git config --local merge.resolve_hash.driver "node bin/cfh.cjs %O %A %B" || true
