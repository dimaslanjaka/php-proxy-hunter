#!/bin/bash

# Set current working directory to parent directory of bin/
CWD=$(dirname "$(dirname "$(realpath "$0")")")

echo "Current directory: $CWD"

# Touch required files
touch "$CWD/assets/index.html"
touch "$CWD/assets/systemctl/index.html"

# Stop services by removing their config from /etc/systemd/system
rm -f "/etc/systemd/system/gunicorn.service"
rm -f "/etc/systemd/system/huey.service"

# Fix permission for gunicorn services (if necessary, you can change or remove this)
chmod 755 "$CWD/assets/systemctl"
chown root:root "$CWD/assets/systemctl/start_gunicorn.sh"
chmod +x "$CWD/assets/systemctl/start_gunicorn.sh"

# Reload daemon to reflect changes
sudo systemctl daemon-reload

# Check and stop OLD PHP-FPM services if installed
php_versions=("7.2" "7.3" "7.4" "8.0" "8.1" "8.2" "8.3" "8.4" "8.5")
for version in "${php_versions[@]}"; do
    # Check if PHP FPM service is active
    if systemctl is-active --quiet php${version}-fpm; then
        sudo systemctl stop php${version}-fpm
        echo "Stopped PHP ${version} FPM"
    fi
done

# Stop PHP-FPM service
if systemctl is-active --quiet php-fpm; then
    sudo systemctl stop php-fpm
    echo "Stopped PHP-FPM service"
else
    echo "PHP-FPM service is not running or not installed."
fi

# Stop Nginx
sudo nginx -t
sudo systemctl stop nginx
echo "Stopped Nginx"

# Stop django services (Gunicorn and Huey)
sudo systemctl stop gunicorn
echo "Gunicorn service stopped"
sudo systemctl stop huey
echo "Huey service stopped"

# Check and stop Spring Boot service if installed (Uncomment if needed)
# if systemctl is-active --quiet spring; then
#     sudo systemctl stop spring
#     echo "Stopped Spring Boot"
# fi

# _____MySQL/MariaDB Service Handling_____
# Try common service names and stop the first one found
mysql_candidates=("mysql" "mysqld" "mariadb")
found_mysql=false
for svc in "${mysql_candidates[@]}"; do
    if systemctl list-unit-files | grep -q "^${svc}\.service"; then
        found_mysql=true
        if systemctl is-active --quiet "${svc}"; then
            sudo systemctl stop "${svc}"
            echo "Stopped ${svc} service"
        else
            echo "${svc} service is not running"
        fi
        break
    fi
done

if [ "$found_mysql" = false ]; then
    echo "No MySQL/MariaDB service found (checked: mysql, mysqld, mariadb)."
fi
