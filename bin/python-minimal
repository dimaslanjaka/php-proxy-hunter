#!/usr/bin/env bash
set -e

# set variable
SCRIPT_DIR="$(dirname "$(realpath "$0")")"
CWD="$(dirname "$SCRIPT_DIR")"
PY="$CWD/bin/py"

# add bin to PATH
export PATH="$CWD/bin:$PATH"

# create venv if not exists and install dependencies
if [ ! -d "venv" ]; then
  if command -v python3 &> /dev/null; then
    python3 -m venv venv
    python3 -m pip install --upgrade pip
  elif command -v python &> /dev/null; then
    python -m venv venv
    python -m pip install --upgrade pip
  else
    echo "Python is not installed." >&2
    exit 1
  fi
fi

if [ -f "venv/bin/activate" ]; then
  . venv/bin/activate
fi

"$PY" -m pip install --upgrade pip || true
"$PY" -m pip install -r "$CWD/requirements-base.txt"
"$PY" -m pip install -r "$CWD/requirements-minimal.txt"
if [ -d "packages/proxy-checker-python" ]; then
  "$PY" -m pip install -e packages/proxy-checker-python
else
  "$PY" -m pip install git+https://github.com/dimaslanjaka/proxy-checker-python.git@master
fi
if [ -d "packages/proxy-hunter-python" ]; then
  "$PY" -m pip install -e packages/proxy-hunter-python
else
  "$PY" -m pip install git+https://github.com/dimaslanjaka/proxy-hunter-python.git@master#subdirectory=packages/proxy-hunter-python
fi
if [ -d "packages/rsa-utility" ]; then
  "$PY" -m pip install -e packages/rsa-utility
else
  "$PY" -m pip install git+https://github.com/dimaslanjaka/php-proxy-hunter.git@master#subdirectory=packages/rsa-utility
fi
