#!/usr/bin/env bash

# Robust cross-platform kill script
# - Uses taskkill on Windows (MSYS/Cygwin/MINGW)
# - Uses pgrep/kil on Unix-like systems and falls back to ps/awk

set -u

echo "Running kills script (PID: $$)"

kill_by_name_unix() {
    local name="$1"
    local pids=""

    if command -v pgrep >/dev/null 2>&1; then
        pids=$(pgrep -f "$name" || true)
    else
        pids=$(ps -ef | grep -i "$name" | grep -v grep | awk '{print $2}' || true)
    fi

    if [ -n "$pids" ]; then
        echo "Killing processes matching '$name': $pids"
        # shellcheck disable=SC2086
        kill -9 $pids 2>/dev/null || echo "Failed to kill some pids: $pids"
    else
        echo "No running processes found for '$name'"
    fi
}

kill_by_name_windows() {
    local proc="$1"
    if command -v taskkill >/dev/null 2>&1; then
        echo "Terminating $proc with taskkill"
        taskkill /F /IM "$proc" 2>/dev/null || true
    else
        echo "taskkill not found, trying wmic for $proc"
        # WMIC might be deprecated on some systems; ignore errors
        wmic process where "name='$proc'" call terminate 2>/dev/null || true
    fi
}

# Normalize OSTYPE/uname detection for common Windows bash environments
case "$(uname -s 2>/dev/null || echo unknown)" in
    CYGWIN*|MINGW*|MSYS*|Windows_NT)
        echo "Detected Windows-like environment: $(uname -s)"
        WINDOWS=true
        ;;
    *)
        WINDOWS=false
        ;;
esac

if [ "$WINDOWS" = true ]; then
    for p in python.exe chrome.exe webdriver.exe chromedriver.exe php.exe node.exe; do
        kill_by_name_windows "$p"
    done
else
    echo "Detected Unix-like environment"
    for name in python python3 chrome webdriver chromedriver php node; do
        kill_by_name_unix "$name"
    done
fi

# Optional: cleanup commented out originally
# rm -f *.lock || true
# composer install
